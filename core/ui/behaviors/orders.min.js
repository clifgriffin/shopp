jQuery(document).ready(function(t){function e(e){void 0==e.variant&&(e.variant=""),data={id:e.id,itemname:e.name+(""!=e.variant?": "+e.variant:""),quantity:e.quantity>0?e.quantity:1,unitprice:e.unitprice},ui=t.tmpl("item-editor",data),n(ui),t("#order-items").append(t("<tr></tr>").append(ui)),ui.find("#edit-item").focus()}function n(e){function n(){$total.val(asMoney($qty.val()*asNumber($unitprice.val())))}var i="#edit-",a=e.find(".choose-product"),o=e.find(".select-product");$unitprice=e.find(i+"unitprice"),$qty=e.find(i+"qty"),$total=e.find(i+"total"),$unitprice.change(function(){n(),$unitprice.val(asMoney($unitprice.val()))}).change(),$qty.change(n).change(),a.on("click",function(t){t.preventDefault(),e.find(i+"item").hide(),e.find(".selectize-control .selectize-input").show().click()}),o.selectize({valueField:"id",labelField:"name",searchField:["name","variant"],openOnFocus:!0,diacritics:!0,maxOptions:7,create:!1,render:{item:function(t,e){return $unitprice.val(t.unitprice).change(),""!=t.variant?'<div><span class="name">'+e(t.name)+'</span><span class="variant">'+e(t.variant)+"</span></div>":'<div><span class="name">'+e(t.name)+"</span></div>"},option:function(t,e){return""!=t.variant?'<div><span class="name">'+e(t.name)+'</span><span class="variant">'+e(t.variant)+'</span> <span class="price">'+e(asMoney(t.unitprice))+"</span></div>":'<div><span class="name">'+e(t.name)+'</span> <span class="price">'+e(asMoney(t.unitprice))+"</span></div>"}},load:function(e,n){if(!e.length)return n();var i=t(this);t.ajax({url:producturl+"&action=shopp_select_product&s="+encodeURIComponent(e),type:"GET",error:function(){n()},success:function(t){n(t),isNaN(e)||1!=t.length||i[0].addItem(t[0].id)}})},onInitialize:function(){t(this.$control).hide()}})}t.template("shipment-ui",t("#shipment-ui")),t.template("shipnotice-ui",t("#shipnotice-ui")),t.template("refund-ui",t("#refund-ui")),t.template("address-ui",t("#address-editor")),t.template("customer-ui",t("#customer-editor")),t.template("total-editor",t("#total-editor-ui")),t.template("item-editor",t("#item-editor-ui")),t("a.shopp-zoom").colorbox({photo:!0});var i=t("#order-manage"),a=i.find("div.manager-ui"),o="";t.each(carriers,function(t,e){o+='<option value="'+t+'">'+e[0]+"</option>"}),t("#shipnote-button").click(function(e){e.preventDefault();var n=t(this).hide(),i=[],s=t.tmpl("shipnotice-ui",{shipmentnum:2}),r=s.find("ol li"),d=function(){r.find("span.number").text(i.length+1+".")};s.find("#addship-button").click(function(e){e.preventDefault();var n=i.length,a=t.tmpl("shipment-ui",{id:n,num:n+1}),s=a.find("select").html(o),c=(a.find(".tracking").change(function(){var e=t(this).val().toUpperCase().replace(/[^A-Z0-9]/,"");t.each(carriers,function(t,n){if(null!=e.match(new RegExp(n[1].substr(1,n[1].length-2))))return s.val(t),!1})}),a.find("button.delete").click(function(t){t.preventDefault(),a.remove(),i.splice(n,1),d()}).hide());n>0&&a.hover(function(){c.show()},function(){c.fadeOut("fast")}),i.push(a.insertBefore(r)),d()}).click(),s.find("#cancel-ship").click(function(t){t.preventDefault(),s.fadeRemove("fast",function(){n.show()})});a.empty().append(s)}),t("#cancel-order, #refund-button").click(function(e){e.preventDefault();var n=t(this).attr("disabled",!0),i="refund-button"==n.attr("id")?{action:"refund",title:$om.ro,cancel:$om.cancel,send:$om.stg,process:$om.pr,reason:$om.rr}:{action:"cancel",title:$om.co,cancel:$om.dnc,send:$om.stg,process:$om.co,reason:$om.rc,disable_amount:' disabled="disabled"'},o=t.tmpl("refund-ui",i);o.find("#cancel-refund").click(function(t){t.preventDefault(),o.fadeRemove("fast",function(){n.show()})});a.empty().append(o)}),t("#print-button").click(function(e){e.preventDefault();var n,i=t("#print-receipt").get(0),a=i.contentWindow,o=-1!==navigator.userAgent.indexOf("Trident"),s=-1!==navigator.userAgent.indexOf("Presto");return o||s?(n=window.open(a.location.href+"&print=auto"),t(n).load(function(){n.close()})):(a.focus(),a.print()),!1});editaddress=function(e){var n=t(this),i=address[e],a=i&&i.statemenu?i.statemenu:[],o=t.tmpl("address-ui",i),s=t("#"+e+"-address-editor"),r=t("#order-"+e+" .display");o.find("#cancel-edit-address").click(function(t){t.preventDefault(),o.fadeRemove("fast",function(){n.show(),r.show()})});o&&(r.hide(),s.hide().empty().append(o).slideDown("fast")),t("#"+e+"-state-menu").html(a).selectize({openOnFocus:!0,diacritics:!0,allowEmptyOption:!0,selectOnTab:!0,create:!0}),t("#"+e+"-country").upstate().selectize({openOnFocus:!0,diacritics:!0,allowEmptyOption:!0,selectOnTab:!0,create:!1})},billaddrctrls=t("#edit-billing-address, #order-billing address").click(function(t){return t.preventDefault(),editaddress("billing"),!1}),billaddrctrls=t("#edit-shipping-address, #order-shipping address").click(function(t){return t.preventDefault(),editaddress("shipping"),!1}),editcustomer=function(e,n){var i=t(this),a=t("#customer-editor-form"),o=t("#order-contact .display"),s=(t("#order-contact .inside"),function(t){t.preventDefault(),n.fadeRemove("fast",function(){i.show(),o.show()})}),r=function(){var e=["billing","shipping"];t("#customer-editor-form, #billing-address-editor, #shipping-address-editor").on("submit",function(n){return n.preventDefault(),t.each(e,function(e,n){t("#"+n+"-address-editor").length>0&&t("#"+n+"-address-editor :input").not(":submit").clone().hide().appendTo("#customer-editor-form")}),t("#customer-editor-form").off("submit").submit(),!1})},d=function(e,n){var i,o=e.email;a.find(".label-heading").html($l10n.newc),t.each(n,function(e,n){t("#customer-"+n).val("")}),a.find(".loginname").length>0&&a.find(".loginname").slideDown(),t("#customer-action").val("new-customer"),o.match(new RegExp(/^[-a-z0-9~!$%^&*_=+}{\'?]+(\.[-a-z0-9~!$%^&*_=+}{\'?]+)*@([a-z0-9_][-a-z0-9_]*(\.[-a-z0-9_]+)*\.([a-z][a-z0-9]+)|([0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}))(:[0-9]{1,5})?$/i))?(t("#customer-email").val(o),t("#customer-firstname").focus()):(i=o.split(" "),t("#customer-firstname").val(i.shift()),t("#customer-lastname").val(i.join(" ")),t("#customer-company").focus()),editaddress("billing"),editaddress("shipping"),r()},c=function(e,n){t.each(n,function(n,i){void 0!=e[i]&&t("#customer-"+i).length>0&&t("#customer-"+i).val(e[i])}),t.ajax({url:addressurl+"&action=shopp_lookup_addresses&id="+encodeURIComponent(e.id),type:"GET",success:function(e){var n=["id","firstname","lastname","address","xaddress","city","state","postcode","country"],i=["billing","shipping"];editaddress("billing"),editaddress("shipping"),t.each(n,function(n,a){t.each(i,function(n,i){void 0!=e[i][a]&&t("#"+i+"-"+a).length>0&&t("#"+i+"-"+a).val(e[i][a])})}),r()}})},l=function(t){var e=["id","firstname","lastname","company","email","phone"];void 0==t.id?d(t,e):c(t,e)};n.find("#select-customer").selectize({valueField:"email",labelField:"email",searchField:["firstname","lastname","email"],openOnFocus:!0,diacritics:!0,maxOptions:7,create:!0,render:{item:function(t,e){return l(t),""},option:function(t,e){var n="<strong>"+e(t.firstname)+" "+e(t.lastname)+"</strong>",i=""!=t.company?', <span class="company">'+e(t.company)+"</span>":"",a=""!=t.email?'<br /><span class="email">'+e(t.email)+"</span>":"";return"<div>"+t.gravatar+'<div class="contact">'+n+i+a+"</div></div>"}},load:function(e,n){if(!e.length)return n();var i=t(this),a=t(i[0].$input).attr("data-url");t.ajax({url:a+"&s="+encodeURIComponent(e),type:"GET",error:function(){n()},success:function(t){n(t),isNaN(e)||1!=t.length||i[0].addItem(t[0].id)}})},onItemAdd:function(t,e){this.clear(),this.clearOptions()}}),n.find("#cancel-edit-customer").click(s);o.hide(),a.hide().empty().append(n).slideDown("fast")},editcustomerbtn=t("#edit-customer").click(function(e){e.preventDefault();var n=t.tmpl("customer-ui",customer);editcustomer(e,n)}),1==t("#order-contact .editor").length&&(editcustomer(!1,t("#order-contact .inside")),editaddress("billing"),editaddress("shipping")),t(".if-js-closed").removeClass("if-js-closed").addClass("closed"),t(".meta-box-sortables").on("sortstart",function(e,n){t(".meta-box-sortables").addClass("sortables-sorting")}).on("sortstop",function(e,n){t(".meta-box-sortables").removeClass("sortables-sorting")}),postboxes._mark_area=function(){var e=t("#side-sortables, #topside-sortables, #topic-sortables, #topsider-sortables, #underside-sortables, #underic-sortables, #undersider-sortables");e.each(function(){var e=t(this);e.length&&(e.children(".postbox:visible").length?e.removeClass("empty-container"):e.addClass("empty-container"))})},postboxes.add_postbox_toggles(pagenow),t(".meta-box-sortables .hndle").on("mousedown",function(e,n){t(".empty-container").height("420px")}),t(".meta-box-sortables").on("sortstop",function(e,n){t(".empty-container").height("0px")}),t(".postbox a.help").click(function(){return t(this).colorbox({iframe:!0,open:!0,innerWidth:768,innerHeight:480,scrolling:!1}),!1}),t("#notification").hide(),t("#notify-customer").click(function(){t("#notification").animate({height:"toggle",opacity:"toggle"},500)}),t("#notation").hide(),t("#add-note-button").click(function(e){e.preventDefault(),t("#add-note-button").hide(),t("#notation").animate({height:"toggle",opacity:"toggle"},500)}),t("#cancel-note-button").click(function(e){e.preventDefault(),t("#add-note-button").animate({opacity:"toggle"},500),t("#notation").animate({height:"toggle",opacity:"toggle"},500)}),t("#order-notes table tr").hover(function(){t(this).find(".notectrls").animate({opacity:"toggle"},500)},function(){t(this).find(".notectrls").animate({opacity:"toggle"},100)}),t("td .deletenote").click(function(t){confirm("Are you sure you want to delete this note?")||t.preventDefault()}),t("td .editnote").click(function(){var e=t(this).attr("disabled",!0).addClass("updating"),n=e.parents("td"),i=n.find("div"),a=n.find("span.notectrls"),o=n.find("p.notemeta"),s=i.attr("id").split("-"),r=s[1];t.get(noteurl+"&action=shopp_order_note_message&id="+r,!1,function(s){if(e.removeAttr("disabled").removeClass("updating"),"1"!=s){var d=t('<textarea name="note-editor['+r+']" cols="50" rows="10" />').val(s).prependTo(n);ui=t('<div class="controls alignright"><button type="button" name="cancel" class="cancel-edit-note button-secondary">Cancel</button><button type="submit" name="edit-note['+r+']" class="save-note button-primary">Save Note</button></div>').appendTo(o),cancel=ui.find("button.cancel-edit-note").click(function(){d.remove(),ui.remove(),i.show(),a.addClass("notectrls")}),i.hide(),a.hide().removeClass("notectrls")}})});var s=t("tr.editing");s.length>0&&n(s);var r=(t(".add-product").selectize({valueField:"id",labelField:"name",searchField:["name","variant"],openOnFocus:!0,diacritics:!0,maxOptions:7,create:!0,render:{item:function(t,n){return e(t),""!=t.variant?'<div><span class="name">'+n(t.name)+'</span><span class="variant">'+n(t.variant)+"</span></div>":'<div><span class="name">'+n(t.name)+"</span></div>"},option:function(t,e){return""!=t.variant?'<div><span class="name">'+e(t.name)+'</span><span class="variant">'+e(t.variant)+'</span> <span class="price">'+e(asMoney(t.unitprice))+"</span></div>":'<div><span class="name">'+e(t.name)+'</span> <span class="price">'+e(asMoney(t.unitprice))+"</span></div>"}},load:function(e,n){if(!e.length)return n();var i=t(this);t.ajax({url:producturl+"&action=shopp_select_product&s="+encodeURIComponent(e),type:"GET",error:function(){n()},success:function(t){n(t),isNaN(e)||1!=t.length||i[0].addItem(t[0].id)}})},onItemAdd:function(t,e){this.clear(),this.clearOptions()}}),"");t(document).keypress(function(e){var n=String.fromCharCode(e.which);13==e.which&&""!=r&&t(".add-product .selectize-input").show().click().find("input").val(r).change(),n.match(/\d/)?r+=n:r=""});var d=t("#order-totals"),c=[],l=function(){var e=parseFloat(d.find("tr.subtotal td.money").attr("data-value")),n=[],i=0,a=["fee","tax","shipping","discount"];t.each(a,function(e,a){var o=d.find("tr.total-editor td.money input."+a);n[a]=0,d.find("tr.total-editor td.money input."+a).each(function(){n[a]+=asNumber(t(this).val())}),o.length>0?t("#"+a+"-total").val(asMoney(n[a])):n[a]=asNumber(t("#"+a+"-total").val()),"discount"==a&&(n.discount*=-1),i+=n[a]});$total=t("#order-total").val(e+i).change()},u=function(){var e=t(this);e.data("initialValue")!=e.val()&&d.addClass("changed"),p(e),l()},p=function(t){var e=t.parent().find(".add");0==asNumber(t.val())?e.hide():e.show().closest("tr").removeClass("empty")};lineEditing=function(e){e.find("button.delete").click(function(){e.fadeOut("fast",function(){e.remove(),0==d.find("tr.total-editor td.money input."+type).length&&t("#"+type+"-total").removeAttr("readonly"),l()})}),e.find("button.add").click(function(t){addLineEditor(t,e)});field=e.find("td.money input.money").change(u).money().selectall().change()},addLineEditor=function(e,n){console.log("addLineEditor"),e.preventDefault();var i=t(e.currentTarget),a=i.closest("tr"),o=i.val(),s=t.tmpl("total-editor",{placeholder:i.attr("data-label"),label:i.attr("data-label"),type:o,amount:0}),r=s.find("td").hide(),d=r.find("input"),l=s.find("input.labeling");return void 0===c[o]?c[o]=t(s).add(a):c[o]=t(c[o]).add(s),d.focus(function(){c[o].addClass("edit-group")}).blur(function(){c[o].removeClass("edit-group")}),lineEditing(s),n?s.insertBefore(n):s.insertBefore(a),r.slideDown("fast"),l.focus(),s},startLineEditor=function(e){e.preventDefault();var n=t(this),i=n.parent().parent().find("td.label"),a=n.closest("tr"),o=a.find("input.money").prop("readonly",!0).addClass("subtotal"),s=o.val(),r=addLineEditor(e);i.html(i.html()+" "+$l10n.total),r.find("input.money").val(s).change(),r.find("input.labeling").focus()},d.find("button.add").not("tr.total-editor button.add").click(startLineEditor),d.find("tr.total-editor").each(function(){lineEditing(t(this))}),t("#order-totals input.money").not("#order-total").change(u).each(function(){var e=t(this);e.data("initialValue",e.val()),p(e)})});