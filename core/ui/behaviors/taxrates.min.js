jQuery(document).ready(function(e){e.template("editor",e("#editor")),e.template("conditional",e("#conditional")),e.template("localrate",e("#localrate")),e.template("property-menu",e("#property-menu")),e.template("countries-menu",e("#countries-menu"));var a=!1,t=e("#no-taxrates");e("#taxrates a.edit, #addrate").click(function(n){n&&n.preventDefault(),t.hide();var l=e(this),o=(rates.length,0),i=l.parents("tr").hide(),d=e.getQueryVar("id",l.attr("href")),s=rates[d]?rates[d]:{},c=e.extend({id:d?d:"new",rate:0,compound:"off",country:!1,zone:!1,logic:"any",rules:[]},s),u=e.tmpl("editor",c),p=u.find("div.conditionals").hide().removeClass("no-conditions"),f=p.find("ul"),h=(u.find("select.logic").val(c.logic),u.find("select.country")),m=u.find("select.zone").hide().removeClass("no-zones"),v=u.find(".local-rates").hide().removeClass("no-local-rates"),g=v.find("ul"),y=u.find(".has-locals"),w=u.find(".add-locals").hide().removeClass("has-local-rates"),C=u.find(".rm-locals").hide().removeClass("no-local-rates"),b=u.find("button.upload"),k=(b.parent(),u.find("p.instructions")),x=u.find("a.cancel"),z=(u.find("#tax-rate").change(function(){this.value=asPercent(this.value,!1,4)}).change(),u.find("#tax-compound").attr("checked","on"==c.compound),u.find("button.add"));l.rules=[],h.html(e.tmpl("countries-menu")).val(c.country).change(function(a){var t=e(this),n="",l=!!zones[t.val()]&&zones[t.val()];0!=l?(n+='<option value=""></option>',e.each(l,function(e,a){n+='<option value="'+e+'">'+a+"</option>"}),m.html(n).val(c.zone).show()):m.empty().hide()}).change(),l.cancel=function(e){e&&e.preventDefault(),a=!1,u.remove(),i.fadeIn("fast"),t.size()>0&&t.show()},x.click(l.cancel),l.addlocals=function(e){e&&e.preventDefault(),w.hide(),C.show(),y.val("true"),v.hide().removeClass("no-local-rates").show()},w.click(l.addlocals),l.rmlocals=function(e){e&&e.preventDefault(),C.hide(),w.show(),y.val("false"),v.fadeOut("fast")},C.click(l.rmlocals),b.upload({name:"ratefile",action:ajaxurl,params:{action:"shopp_upload_local_taxes",_wpnonce:e("#_wpnonce").val()},accept:"text/plain,text/xml",maxfilesize:"1048576",onSubmit:function(){g.empty(),k.empty().removeClass("error"),b.attr("disabled",!0).addClass("updating").parent().css("width","100%")},onComplete:function(a){b.removeAttr("disabled").removeClass("updating");try{r=e.parseJSON(a),r.error?k.addClass("error").html(r.error):l.addlocals(r)}catch(t){alert("LOCAL_RATES_UPLOADERR")}}}),l.addlocalrate=function(a,t){var n={id:c.id,localename:a,localerate:asNumber(t)};e.tmpl("localrate",n).appendTo(g)},l.addlocals=function(a){e.each(a,function(e,a){l.addlocalrate(e,a)}),k.empty()},c.haslocals?(void 0!=c.locals&&l.addlocals(c.locals),v.show(),C.show()):w.show(),l.addrule=function(a,t,n){a&&a.preventDefault(),t||(t=o),n||(n={}),n.id=c.id,n.ruleid=t,n.rulevalue=n.v;var i=e.tmpl("conditional",n).appendTo(f),r=i.find("input.value"),d=(i.find("select.property").html(e.tmpl("property-menu")).val(n.p).change(function(){r.unbind("keydown").unbind("keypress").suggest(suggurl+"&action=shopp_suggestions&t="+e(this).val(),{delay:500,minchars:2,format:"json"})}).change(),i.find("button.delete").click(function(e){e&&e.preventDefault(),i.remove(),l.rules.pop(),0==l.rules.length&&p.hide()}).hide());addrulebtn=i.find("button.add").click(l.addrule),i.hover(function(){d.show()},function(){d.fadeOut("fast")}),p.show(),o++,l.rules.push(o)},z.click(l.addrule),c.rules.length>0&&e.each(c.rules,function(e,a){l.addrule(!1,e,a)}),i.size()>0?u.insertAfter(i):u.prependTo("#the-list"),quickSelects(),a=l})});