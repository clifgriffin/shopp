jQuery(document).ready(function(){function e(e,n,t,a,i){var s=jQuery,d=l++,c=!1,o=rule_types[n],r=rule_groups[n.substr(0,n.indexOf("_"))],f=s.tmpl("panelUI",{label:r+" "+o,type:"rule "+n}),u=f.find("div.ui"),p=f.find("button.delete").hide().click(function(){return!!confirm(DELETE_RULE_PROMPT)&&(e.trigger("rule-change",[n,c.find("option:selected").attr("class"),!0]),void f.fadeRemove())}),c=(f.find("div.label").hover(function(){p.show()},function(){p.fadeOut("fast")}),s.tmpl("accessMenu",{name:"stages["+a+"][rules]["+n+"]["+d+"][access]"}).appendTo(u).find("select.access").change(function(){c.find("option:selected").attr("class");c.val().indexOf("-all")==-1?h.ui.show():h.ui.hide(),e.trigger("rule-change",[n])})),h=new SearchSelector(n,u,sugg_url,"stages["+a+"][rules]["+n+"]["+d+"][content]","Type the name of the "+r+" "+o+" to add.","membership");return t!==!1?c.val(t):c.val,i&&s.each(i,function(e,n){h.ui.prepend(h.newItem(e,n))}),t||(t=c.val()),f.appendTo(e),i||c.change(),this}function n(i,l){a.push(this);var s=a.length,d=(a.length>1?STAGES_LABEL:STAGE_LABEL,t.tmpl("panelUI",{type:"stage"})),c="undefined"==typeof l||"undefined"==typeof l.id?"":l.id,o=t.tmpl("stagePanelControls",{index:s,id:c}).appendTo(d),r=d.find("div.ui"),f=t("<ul/>").appendTo(r),u=d.find("div.label"),p=function(n,t){new e(f,n,(!1),s)},h=d.find("select.content").change(function(){var e=t(this);p(e.val()),e.val("")}),g=o.find("span.schedule").hide(),v=d.find("select.period"),b=(d.find("select.interval").change(function(){var e=t(this),n=bill_periods[0],a=v.find("option:first").html(),i=v.val();"1"==e.val()&&(n=bill_periods[1]),a!=n[0].label&&(v.html(""),t.tmpl("billPeriodOptions",n).appendTo(v),v.val(i))}).change(),d.find("input.advance").change(function(){b.attr("checked")?g.show():g.hide()}).click(function(){b.attr("checked")&&!d.next().get(0)&&new n(i)})),m=u.find("button.delete").hide().click(function(){return!!confirm(DELETE_GROUP_PROMPT)&&(a.splice(s-1,1),void d.fadeRemove("fast",function(){a.length>1?i.find("li.stage").addClass("advance").last().removeClass("advance"):i.removeClass("steps").find("li.stage:last").removeClass("advance"),i.find("li.stage div.label").trigger("relabel")}))}),_=function(n){var a=[];t.each(n,function(n,i){"content"==n&&(a=i),"rules"==n&&(t.each(i,function(n,i){t.each(i,function(n,t){new e(f,t.name,t.value,s,a[t.id])})}),f.trigger("rule-change",[n]),a=[])}),n.settings&&t.each(n.settings,function(e,n){var t=o.find("."+e);t.is("input[type=checkbox]")&&n==t.val()&&t.attr("checked",!0),t.is("select")&&t.val(n),t.change()})};u.hover(function(){d.prev().get(0)&&m.show()},function(){m.fadeOut("fast")}),f.bind("rule-change",function(e,n,a){var i=t(this).find("li."+n+" div.ui select.access"),l=[],s=!1;i.each(function(e,n){var a=t(n).find("option:selected").attr("class");t.inArray(a,l)==-1&&l.push(a)}),i.find("option").attr("disabled",!1),i.each(function(e,n){var a=t(n),i=0==e?1:0,d=l[i];d&&(a.find("option."+d).attr("disabled",!0),a.find("option:selected").attr("disabled")&&(a.find("option:enabled:first").attr("selected",!0),s=!0))}),2==l.length?h.find("option[value="+n+"]").attr("disabled",!0):h.find("option[value="+n+"]").attr("disabled",!1),s&&f.trigger("rule-change",[n])}),u.bind("relabel",function(){var e=a.length>1?STAGES_LABEL:STAGE_LABEL;u.find("label").html(e)}).trigger("relabel"),a.length>1&&i.addClass("steps").find("li.stage").addClass("advance").find("div.label").trigger("relabel"),l&&_(l),d.appendTo(i).parent().sortable("refresh"),b.change()}var t=jQuery,a=[],i=t("#rules"),l=0;postboxes.add_postbox_toggles("shopp_page_shopp-memberships"),t(".if-js-closed").removeClass("if-js-closed").addClass("closed"),t(".postbox a.help").click(function(){return t(this).colorbox({iframe:!0,open:!0,innerWidth:768,innerHeight:480,scrolling:!1}),!1}),t.template("panelUI",t("#panelUI")),t.template("stagePanelControls",t("#stagePanelControls")),t.template("billPeriodOptions",t("#billPeriodOptions")),t.template("accessMenu",t("#accessMenu")),t("#add-stage").click(function(){new n(i)}),rules?t.each(rules,function(e,t){new n(i,t)}):new n(i),i.sortable({axis:"y",handle:"div.label",update:function(e,n){a.length>1&&i.find("li.stage").addClass("advance").last().removeClass("advance").find("input.advance").attr("checked",!1).change()}})});